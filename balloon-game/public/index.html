<!DOCTYPE html>
<html>
  <head>
    <style>
      .balloon {
        height: var(--balloonSize);
        width: var(--balloonSize);

        border: 1px solid gray;
        border-radius: 50%;
        cursor: pointer;
        position: absolute;
        transition: top 3s ease-in;
      }

      .banner {
        position: absolute;
        top: 1rem;
        left: 1rem;
      }

      body {
        --balloonSize: 100px;

        background-color: skyblue;
        font-family: sans-serif;
        font-size: 2rem;
        margin: 0;
        position: relative;
      }

      button {
        border: none;
        border-radius: 0.5rem;
        font-size: 2rem;
        padding: 0.5rem;
      }
    </style>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script>
      let balloonSize = 0;
      const gameDuration = 3;

      window.onload = () => {
        balloonSize = parseInt(
          getComputedStyle(document.body).getPropertyValue('--balloonSize')
        );
      };

      const pop = new Audio('pop.mp3');

      function createBalloon() {
        const balloon = document.createElement('div');
        htmx.addClass(balloon, 'balloon');
        balloon.style.backgroundColor = getRandomColor();
        const maxLeft = window.innerWidth - balloonSize;
        const left = Math.floor(Math.random() * maxLeft);
        balloon.style.left = `${left}px`;
        balloon.style.top = `-${balloonSize}px`; // off screen
        return balloon;
      }

      function endGame(data) {
        data.playing = false;

        // Prevent clicking any of the remaining balloons.
        const balloons = htmx.findAll('.balloon');
        for (const balloon of balloons) {
          htmx.off(balloon, 'click', balloon.clickHandler);
        }
      }

      function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }

      function startGame(data) {
        data.playing = true;
        data.score = 0;
        data.seconds = gameDuration;

        // Update the seconds remaining.
        const timer = setInterval(() => {
          data.seconds--;
          if (data.seconds == 0) {
            clearInterval(timer);
            clearInterval(dropper);
            endGame(data);
          }
        }, 1000);

        // Create a new balloon every second.
        const dropper = setInterval(() => {
          const balloon = createBalloon();

          // Remove the balloon when it hits the ground.
          htmx.on(balloon, 'transitionend', () => {
            pop.play();
            htmx.remove(balloon);
          });

          // Remove the balloon when it is clicked.
          const clickHandler = () => {
            pop.play();
            data.score++;
            htmx.remove(balloon);
          };
          htmx.on(balloon, 'click', clickHandler);

          // Save the listener so it's easy to remove it later.
          balloon.clickHandler = clickHandler;

          document.body.appendChild(balloon);

          // Drop the balloon.
          setTimeout(() => {
            balloon.style.top = window.innerHeight - balloonSize + 'px';
          }, 0);
        }, 1000);
      }
    </script>
  </head>
  <body x-data="{playing: false, seconds: 0, score: 0}">
    <div class="banner">
      <template x-if="!playing">
        <button @click="startGame($data)">Play</button>
      </template>
      <span>Score: <span x-text="score"></span></span>
      <template x-if="playing">
        <span>, Seconds Remaining: <span x-text="seconds"></span></span>
      </template>
    </div>
  </body>
</html>
